# Hanzo Platform - Digital Ocean Deployment Workflow
# Deploys to DO App Platform and manages infrastructure

name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main
    paths:
      - "hanzo-node/**"
      - "console/**"
      - "platform/**"
      - "deploy/**"
      - ".github/workflows/do-deploy.yml"

  pull_request:
    branches:
      - main
    paths:
      - "deploy/terraform/**"
      - "deploy/do/**"

  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      action:
        description: "Deployment action"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - plan
          - apply
          - destroy

env:
  DOCTL_VERSION: "1.101.0"
  TERRAFORM_VERSION: "1.6.6"
  NODE_VERSION: "20"
  RUST_VERSION: "1.82"

jobs:
  # ==========================================================================
  # Validate and Test
  # ==========================================================================
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: deploy/terraform

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: deploy/terraform

      - name: Terraform Validate
        run: terraform validate
        working-directory: deploy/terraform

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Validate App Spec
        run: doctl apps spec validate deploy/do/app.yaml

  # ==========================================================================
  # Build Docker Images
  # ==========================================================================
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' || github.event.inputs.action == 'deploy'

    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DO Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.digitalocean.com
          username: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          password: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: registry.digitalocean.com/hanzo/hanzo-node
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=semver,pattern={{version}}

      # Build hanzo-node
      - name: Build and push hanzo-node
        uses: docker/build-push-action@v5
        with:
          context: hanzo-node
          file: hanzo-node/Dockerfile
          push: true
          tags: |
            registry.digitalocean.com/hanzo/hanzo-node:${{ steps.meta.outputs.version }}
            registry.digitalocean.com/hanzo/hanzo-node:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      # Build console
      - name: Build and push console
        uses: docker/build-push-action@v5
        with:
          context: console
          file: console/Dockerfile
          push: true
          tags: |
            registry.digitalocean.com/hanzo/console:${{ steps.meta.outputs.version }}
            registry.digitalocean.com/hanzo/console:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            HANZO_NODE_URL=https://api.hanzo.network

  # ==========================================================================
  # Terraform Plan (PRs only)
  # ==========================================================================
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request' || github.event.inputs.action == 'plan'

    env:
      TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      TF_VAR_spaces_access_id: ${{ secrets.SPACES_ACCESS_ID }}
      TF_VAR_spaces_secret_key: ${{ secrets.SPACES_SECRET_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init
        working-directory: deploy/terraform

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var="environment=${{ github.event.inputs.environment || 'staging' }}" \
            -no-color \
            -out=tfplan
        working-directory: deploy/terraform
        continue-on-error: true

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Plan \`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`

            </details>

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # ==========================================================================
  # Terraform Apply (Manual or on main)
  # ==========================================================================
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [validate, build-images]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event.inputs.action == 'apply'
    environment: ${{ github.event.inputs.environment || 'staging' }}
    env:
      TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      TF_VAR_spaces_access_id: ${{ secrets.SPACES_ACCESS_ID }}
      TF_VAR_spaces_secret_key: ${{ secrets.SPACES_SECRET_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init
        working-directory: deploy/terraform

      - name: Terraform Apply
        run: |
          terraform apply \
            -var="environment=${{ github.event.inputs.environment || 'staging' }}" \
            -auto-approve
        working-directory: deploy/terraform

  # ==========================================================================
  # Deploy to App Platform
  # ==========================================================================
  deploy-app:
    name: Deploy to DO App Platform
    runs-on: ubuntu-latest
    needs: [build-images, terraform-apply]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event.inputs.action == 'deploy'
    environment: ${{ github.event.inputs.environment || 'staging' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Get App ID
        id: app
        run: |
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "hanzo-platform" | awk '{print $1}')
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT

      - name: Update App Spec
        if: steps.app.outputs.app_id != ''
        run: |
          doctl apps update ${{ steps.app.outputs.app_id }} --spec deploy/do/app.yaml

      - name: Create App (if not exists)
        if: steps.app.outputs.app_id == ''
        run: |
          doctl apps create --spec deploy/do/app.yaml

      - name: Trigger Deployment
        run: |
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "hanzo-platform" | awk '{print $1}')
          doctl apps create-deployment $APP_ID --wait

  # ==========================================================================
  # Run Database Migrations
  # ==========================================================================
  migrate:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: deploy-app
    if: github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Run Migrations
        run: |
          # Get database connection string from app
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "hanzo-platform" | awk '{print $1}')

          # Trigger migration job
          doctl apps create-deployment $APP_ID \
            --force-rebuild \
            --wait

  # ==========================================================================
  # Health Check
  # ==========================================================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy-app
    if: always() && needs.deploy-app.result == 'success'

    steps:
      - name: Wait for deployment
        run: sleep 60

      - name: Check Console Health
        run: |
          response=$(curl -sf https://console.hanzo.network/api/health || echo "failed")
          if [[ "$response" == "failed" ]]; then
            echo "Console health check failed"
            exit 1
          fi
          echo "Console is healthy"

      - name: Check Node Health
        run: |
          response=$(curl -sf https://api.hanzo.network/health || echo "failed")
          if [[ "$response" == "failed" ]]; then
            echo "Node health check failed"
            exit 1
          fi
          echo "Node is healthy"

      - name: Notify Success
        if: success()
        run: |
          echo "Deployment successful!"
          echo "Console: https://console.hanzo.network"
          echo "API: https://api.hanzo.network"

  # ==========================================================================
  # Cleanup (on PR close)
  # ==========================================================================
  cleanup:
    name: Cleanup Staging
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup Preview Environment
        run: |
          echo "Cleaning up preview environment for PR #${{ github.event.pull_request.number }}"
          # Add cleanup logic here if using preview environments
